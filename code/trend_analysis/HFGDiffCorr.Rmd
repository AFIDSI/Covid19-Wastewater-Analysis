---
title: "HFGDiffCorr"
author: "Marlin"
date: "2022-10-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```



```{r cars}
library(DSIWastewater)
library(dplyr)
library(ggplot2)
library(tidyr)
data("HFGWaste_data", package = "DSIWastewater")

```

```{r}

#crazy agressive method
hfg_outlier_detection <- function(small_vec){
  upbound_vec <- quantile(small_vec, probs = .7, na.rm = TRUE)
  retVec = ifelse(small_vec > upbound_vec,
                  NA, small_vec)
  retVec = ifelse(retVec == 0, NA, retVec)
  return(retVec)
}
hfg_waste_filt_df <- HFGWaste_data%>%
  select(site, date, Filter, Well, N1, N2, PMMOV, BCoV, HF183, CrP)%>%
  group_by(date,site)%>%
  mutate(across(N1:CrP, hfg_outlier_detection))


#HFGWaste_data%>%
#select(site, date, Filter, Well, N1, N2, PMMOV, BCoV, HF183, CrP)%>%
#  filter(site == "Platteville",
#         date == as.Date("2021-03-01"))
```

```{r}
trend_df <- hfg_waste_filt_df%>%
  group_by(site)%>%
  group_split()%>%
  lapply(loessSmoothMod, InVar = "N1", OutVar = "N1Loess")%>%
  lapply(loessSmoothMod, InVar = "N2", OutVar = "N2Loess")%>%
  lapply(loessSmoothMod, InVar = "PMMOV", OutVar = "PMMOVLoess")%>%
  lapply(loessSmoothMod, InVar = "HF183", OutVar = "HF183Loess")%>%
  lapply(loessSmoothMod, InVar = "CrP", OutVar = "CrPLoess")%>%
  bind_rows()

trend_diff_df = trend_df%>%
  mutate(N1 = N1 - N1Loess,
         N2 = N2 - N2Loess,
         PMMoV = PMMOV - PMMOVLoess,
         HF183 = HF183 - HF183Loess,
        Crp = CrP - CrPLoess)%>%
  select(date, site, N1, N2, PMMoV, HF183, Crp)

SumVariance <- trend_diff_df%>%
  summarise(N1 = var(N1 ,na.rm = TRUE),
            N2 = var(N2 ,na.rm = TRUE),
            PMMoV = var(PMMoV ,na.rm = TRUE),
            HF183 = var(HF183 ,na.rm = TRUE),
            Crp = var(Crp ,na.rm = TRUE))%>%
  mutate(log = FALSE)

SumVariance%>%
  pivot_longer(N1:Crp)%>%
  ggplot()+
  geom_col(aes(x = name, y = value))


library(ggcorrplot)
trend_diff_df%>%
  select(N1, N2, PMMoV, HF183, Crp)%>%
  cor(use = "complete.obs")%>%
  ggcorrplot()


trend_diff_df%>%
  pivot_longer(N1:Crp)%>%
  ggplot(aes(x = date, y = value, color = name))+
  geom_point()+
  facet_wrap(~site)
```
```{r fig.height = 15, fig.width= 15}

library(GGally)
ggpairs(trend_diff_df, aes(colour = site, alpha = 0.4))
```


```{r}
log_trend_df <- hfg_waste_filt_df%>%
  mutate(log_N1 = log(N1),
         log_N2 = log(N2),
         log_PMMOV = log(PMMOV),
         log_HF183 = log(HF183),
         log_CrP = log(CrP))%>%
  group_by(site)%>%
  group_split()%>%
  lapply(loessSmoothMod, InVar = "log_N1", OutVar = "log_N1Loess")%>%
  lapply(loessSmoothMod, InVar = "log_N2", OutVar = "log_N2Loess")%>%
  lapply(loessSmoothMod, InVar = "log_PMMOV", OutVar = "log_PMMOVLoess")%>%
  lapply(loessSmoothMod, InVar = "log_HF183", OutVar = "log_HF183Loess")%>%
  lapply(loessSmoothMod, InVar = "log_CrP", OutVar = "log_CrPLoess")%>%
  bind_rows()

log_trend_Diff_df <- log_trend_df%>%
  mutate(log_N1 = log_N1 - log_N1Loess,
         log_N2 = log_N2 - log_N2Loess,
         log_PMMoV = log_PMMOV - log_PMMOVLoess,
         log_HF183 = log_HF183 - log_HF183Loess,
         log_Crp = log_CrP - log_CrPLoess)%>%
         select(date, site, log_N1, log_N2, log_PMMoV, log_HF183, log_Crp)

logVariance <- log_trend_Diff_df%>%
  summarise(N1 = var(log_N1, na.rm = TRUE),
            N2 = var(log_N2, na.rm = TRUE),
            PMMoV = var(log_PMMoV, na.rm = TRUE),
            HF183 = var(log_HF183, na.rm = TRUE),
            Crp = var(log_Crp, na.rm = TRUE))%>%
  mutate(log = TRUE)

logVariance%>%
  pivot_longer(N1:Crp)%>%
  ggplot()+
  geom_col(aes(x = name, y = value))

log_trend_Diff_df%>%
  select(log_N1, log_N2, log_PMMoV, log_HF183, log_Crp)%>%
  cor(use = "complete.obs")%>%
  ggcorrplot()

log_trend_Diff_df%>%
  pivot_longer(log_N1:log_Crp)%>%
  ggplot(aes(x = date, y = value, color = name))+
  geom_point()+
  facet_wrap(~site)
```

```{r fig.height = 15, fig.width= 15}
library(GGally)
ggpairs(log_trend_Diff_df, aes(colour = site, alpha = 0.4))
```

```{r}
sub_var <- bind_rows(SumVariance, logVariance)
sub_var
```

