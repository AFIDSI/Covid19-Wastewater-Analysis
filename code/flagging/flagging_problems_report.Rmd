---
header-includes:
- \usepackage{wrapfig}
title: "problems in the DHS Covid-19 Flagging methods"
author:
- Marlin Lee, Steve Goldstein, Kyllan Wunder, Abe Megahed
- "University of Wisconsin Data Science Institute - August, 2022"
output:
  pdf_document:
    keep_tex: true     
---

Outline:

-   Describe report
-   Describe viz used in analysis
-   flagging noise
-   Trend
-   Day of week


This analysis looks to show three issues in the DHS wastewater and case flagging methods.
These methods have too narrow a scope leading to missing long term trends and over weighting
fluctuations based on noise. Furthermore the case data has a strong day of the week effect 
leading to unjustified flags being created.

```{r set up markdown settings, include =FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	echo = FALSE,
	#fig.pos = 'H',
	fig.align = 'Right'#,
	#out.width= "65%"
)

defOut <- knitr::knit_hooks$get("plot")  # save the default plot hook

knitr::knit_hooks$set(plot = function(x, options) {  # set new plot hook ...
  
  x <- defOut(x, options)  # first apply the default hook
  # create the new opening string for the wrapfigure environment ...
  wf <- sprintf("\\begin{wrapfigure}{%s}{%g\\textwidth}", "R", .7)
  
  x  <- gsub("\\begin{figure}", wf, x, fixed = T)  # and replace the default one with it.
  
  x  <- gsub("{figure}", "{wrapfigure}", x, fixed = T)  # also replace the environment ending
  return(x)
})
```

```{r,  fig.cap = "Wastewater with flagged dates and quantintle info"}

library(DSIWastewater)
#load WasteWater_data into the environment
data(WasteWater_data, package = "DSIWastewater")

#restrict Waste data to only Madison data
baseWaste_DF <- WasteWater_data[WasteWater_data$wwtp_name == "Madison MSD WWTF",]

#get DF into format for buildRegressionEstimateTable
baseWaste_DF <-  buildWasteAnalysisDF(baseWaste_DF)

#add quantile data to merge with the regression results
Quantiles_DF <- MakeQuantileColumns(baseWaste_DF,
                                    .8, 90,
                                    "sars_cov2_adj_load_log10")

#Get 5 day rolling regression of data
CDCMethod <- buildRegressionEstimateTable(baseWaste_DF,
                                          PSigTest=FALSE)
#merge the regression DF and the quantile DF to get info for 

FULL_reg_DF <- dplyr::full_join(Quantiles_DF, CDCMethod,
                                by = c("WWTP", "date"))

#create flags described in @return
FULL_reg_DF <- ClassifyQuantileFlagRegression(FULL_reg_DF)

#return only flags and type columns 
Full_wasteFlags <- FULL_reg_DF[,c("WWTP", "date", 
                                  "sars_cov2_adj_load_log10",
                                  "ntile",
                                  "cdc_flag",
                                  "flag_ntile",
                                  "flag_ntile_pval",
                                  "modeled_percentchange",
                                  "lmreg_sig")]


library(ggplot2)
library(dplyr)

#"80th percentile of last 90 days"
Quantile_Viz_Plot <- Full_wasteFlags%>%
  ggplot(aes(x = date))+
  geom_point(aes(y = 10^(sars_cov2_adj_load_log10)))+
  geom_line(aes(y = 10^(ntile), color = "Filtered CDC Flag"))+
  geom_point(aes(y = 10^(sars_cov2_adj_load_log10),
                 color = "CDC flag"), 
             data = filter(Full_wasteFlags, cdc_flag == 1))+
  ylab("Covid-19 gene copy per 100k")+
  scale_y_log10()+
  scale_x_date(limits = c(as.Date("2021-01-01"),
                          max(Full_wasteFlags$date)))


Quantile_Viz_Plot
```
\

# The Data


The department of health services has created flagging methods to to predicatively warn of 
spikes in Wisconsin community's to better inform decision making policy. 

## Wastewater method

The wastewater method uses a two step system to identify potential warning signs in the data. 
The core method is using a five measurement rolling regression to calculate an estimated percent 
change over the time period. Then if it is estimated to be over 100% increase it is logged as a 
CDC flag. Then if the measurement is in the 80th percentile of the last 90 days it is logged as a flag. to the right is a visualization we will be using heavily in this report. It shows the wastewater data
measurements with the color showing the flags with a line showing the quantile info. The flags are the
red points above the line.

```{r, fig.cap = "Case slope"}
library(DSIWastewater)

#load Case_data into the environment
data(Case_data, package = "DSIWastewater")


#restrict Case data to only Madison data
Case_DF <- Case_data[Case_data$Site == "Madison",]


#restrict Case data to dates after 2021-02-01
Case_DF <- Case_DF[Case_DF$date  >= as.Date("2021-02-01"),]


#get the case flags
Case_DF <- buildCaseAnalysisDF(Case_DF)


CaseRegressionOutput <- buildRegressionEstimateTable(DataMod = Case_DF, 
    RunOn = c("FirstConfirmed.Per100K", "pastwk.avg.casesperday.Per100K"),
    SplitOn = "Site", DaysRegressed = 7)


library(tidyr)

Case_Flag_Viz_Plot <- CaseRegressionOutput%>%
  select(date, Method, lmreg_slope)%>%
  pivot_wider(names_from = Method, values_from = lmreg_slope)%>%
  ggplot(aes(x = date))+
  geom_line(aes(y = FirstConfirmed.Per100K, color = "cases slope"))+
  geom_line(aes(y = pastwk.avg.casesperday.Per100K, color = "smooth cases slope"))+
  geom_hline(yintercept = 5)+
  ylab("7 day estimated slope (Cases per day)")

Case_Flag_Viz_Plot
```
\


## Case method

The case method uses a 7 day rolling regression to create flags. If the regressed slope is over 5
It is logged as a case flag. Because the slopes are roughly continuous case flags are often repeated
bringing use of the slope switch flag which logged only the first case flag in a sequence. On the right is a visualization we will use in this report. It shows the case slopes vs the seven day smoothing slope data with a horizontal line showing the threshold to be classified as a case flag



```{r}
Full_wasteFlags%>%
  mutate(Date_Case = case_when(
    date < as.Date("2021-06-01") ~ 1,
    date > as.Date("2022-01-01") ~ 3,
    TRUE ~ 2
  ))%>%
  group_by(Date_Case)%>%
  summarise(AVG_CDC_Flag = 100*sum(cdc_flag)/n(), AVG_flag_ntile = 100*sum(flag_ntile)/n())
```
\

# Trend

The largest problem is a structural one. Both flagging methods rely on short term
information to try to detect long term changes in the data. This inherently means
a lack of confidence in the flags because in the short term there is no difference
between normal fluctuation and start of a spike. The 90 day rolling 80th percentile
filter for the waste water flags is a good first step of correcting this. 


```{r fig.cap = "waste counts", out.height="200%}

linedata <- data.frame(x = c(as.Date("2021-05-1"), as.Date("2021-05-1"), 
                             as.Date("2021-08-1"), as.Date("2021-08-1"),
                             as.Date("2021-05-1")),
                       y = c(2, 150, 150, 2, 2))

A <- Quantile_Viz_Plot+
  geom_path(data = linedata, aes(x, y),
            linetype = "solid")

B <- Quantile_Viz_Plot+
  scale_x_date(limits = c(as.Date("2021-05-1"),
                          as.Date("2021-08-1")))+
  scale_y_continuous(limits = c(2, 150))

library(patchwork)

A/B
```

\

# Noise

Because Covid-19 spikes happen over many measurements flagging method should have
auto correlated flags. This is shown in the case flag where the flags are extremely
auto correlated. If this is not the case it can be a sign that the method 
is strongly effected by natural variance in the system. The right plot shows that 
many of the CDC flags are created by natural jumps in the measurement not caused 
by any underlying trend. The quantile filter helps filter some of the more egregious
flags but if the measurement is especially unusual high it can pass the filter
even if the rest of the measurements fall well below the line.




```{r fig.cap = "Zoomed in case slope plot"}

Case_Flag_Viz_Plot+
  scale_x_date(limits = c(as.Date("2021-08-10"),
                          as.Date("2021-10-01")))+
  scale_y_continuous(limits = c(-8, 10))+
  geom_vline(aes(xintercept = date, color = "Friday"),
             data = filter(CaseRegressionOutput, weekdays(date) == "Friday"))
```

\

# Day of week effect

Case data is known to have a day of the week effect where regardless of trends some days have more reported cases then others. It is not immediately obvious that this would effect the output of the 7 day regression but the plot on the right clearly shows that this effect causes Fridays estimated slope
to be larger. On September 17th this effect combined with an unusual high measurement causes
it to labeled as a flag. This effect is removed by using a 7 day smoothing before regression or by
using a regression window larger then 7 days.