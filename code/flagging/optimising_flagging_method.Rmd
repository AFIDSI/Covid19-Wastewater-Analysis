---
title: "test server"
author: "Marlin"
date: "2022-09-23"
output: html_document
---



```{r cars}
library(plotly)
library(ggplot2)
library(DSIWastewater)
#load WasteWater_data into the environment
data(WasteWater_data, package = "DSIWastewater")

#get DF into format for buildRegressionEstimateTable
baseWaste_DF <-  buildWasteAnalysisDF(WasteWater_data)
baseWaste_DF$site <- ifelse(baseWaste_DF$site == "Madison MSD WWTF",
                            "Madison", baseWaste_DF$site)
baseWaste_DF <- baseWaste_DF[!(baseWaste_DF$site %in% c("Portage WWTF","Cedarburg WWTF")),]


baseWaste_DF <- baseWaste_DF[baseWaste_DF$n > 10,]

#add quantile data to merge with the regression results
Quantiles_DF <- makeQuantileColumns(baseWaste_DF,
                                    3:8/10, c(14, 30, 60, 90),
                                    "sars_cov2_adj_load_log10")

Quantiles_DF <- Quantiles_DF[,c("site", "date", "window", "quant", "ntile", "pastKavg.wwlog10")]
Quantiles_DF <- tidyr::pivot_wider(Quantiles_DF, 
                                   names_from = c(window, quant), 
                                  values_from = c(ntile, pastKavg.wwlog10))

#Get 5 day rolling regression of data
CDCMethod <- buildRegressionEstimateTable(baseWaste_DF,
                                          PSigTest=FALSE)

CDCMethod <- CDCMethod[,c("date","site", "modeled_percentchange", "lmreg_sig")]
#merge the regression DF and the quantile DF to get info for 

library(dplyr)

FULL_reg_DF <- full_join(Quantiles_DF, CDCMethod,
                                by = c("site", "date"))%>%
  tidyr::pivot_longer(cols = 'ntile_14_0.3':'pastKavg.wwlog10_90_0.8',
                      names_to = c("column_Name","window", "quant"),
                      values_to = "value",
                      names_sep = "_")%>%
  tidyr::pivot_wider(names_from = column_Name,values_from = value)

#create flags described in @return
FULL_reg_DF <- classifyQuantileFlagRegression(FULL_reg_DF)

#return only flags and type columns 
Full_wasteFlags <- FULL_reg_DF[,c("site", "date",
                                  "window", "quant",
                                  "cdc_flag",
                                  "flag_ntile",
                                  "flag_ntile_Pval")]
```


```{r}
data(Case_data, package = "DSIWastewater")

Case_DF <- Case_data

#get the case flags
Case_DF <- buildCaseAnalysisDF(Case_DF)


CaseRegressionOutput <- buildRegressionEstimateTable(DataMod = Case_DF, 
    RunOn = c("FirstConfirmed.Per100K", "pastwk.avg.casesperday.Per100K"),
    SplitOn = "site", DaysRegressed = 7)

case_flags_names <- c("case_flag", 
                                 "case_flag_plus_comm.threshold",
                                 "slope_switch_flag")

CaseRegressionOutput$Method <- ifelse(CaseRegressionOutput$Method == "FirstConfirmed.Per100K",
                                      "Cases", "7DayCases")


library(dplyr)
#Classify slope to create 3 flags described in @return  
CaseFlags <- classifyCaseRegression(CaseRegressionOutput)%>%
  select(Method, site, date,all_of(case_flags_names))%>%
  tidyr:::pivot_wider(names_from = "Method", values_from = case_flags_names)
```

```{r}
Full_wasteFlags <- Full_wasteFlags%>%
  rename(cdc.flag = cdc_flag, flag.ntile = flag_ntile, flag.ntile.Pval = flag_ntile_Pval)%>%
  tidyr::pivot_wider(names_from = c(window, quant), 
                     values_from = c(cdc.flag, flag.ntile, flag.ntile.Pval))

Flag_DF <- left_join(CaseFlags, Full_wasteFlags, 
                     by = c("site", "date"))

date_Flag_DF <- DF_date_vector(Flag_DF, "date", 
               names(Flag_DF)[3:80])
```

```{r}
#"case_flag_Cases"                         "case_flag_7DayCases"                    
#"case_flag_plus_comm.threshold_Cases"     "case_flag_plus_comm.threshold_7DayCases"
#"slope_switch_flag_Cases"                 "slope_switch_flag_7DayCases"
edgeThresh <- 7
DateDistDF <- date_distance_calc(date_Flag_DF, "case_flag_Cases", 
                                 dep_flags, edge = edgeThresh)%>%
  select(site, date, dep_flags)%>%
  tidyr::pivot_longer(cols = dep_flags,
                      names_to = c("FlagType","window", "quant"),
                      values_to = "FlagError",
                      names_sep = "_")%>%
  mutate(window = as.numeric(window), quant = as.numeric(quant))

DistSummary <- DateDistDF%>%
  group_by(window, quant, FlagType)%>%
  summarise(MeanErrorSquard = mean(FlagError^2, na.rm = TRUE),
            Var = var(FlagError, na.rm = TRUE),
            n = sum(!is.na(FlagError)),
            Missed = mean(FlagError == edgeThresh, na.rm = TRUE))

plot_ly(DistSummary, x = ~window, y = ~quant, z = ~MeanErrorSquard, color = ~FlagType)%>% add_markers()
plot_ly(DistSummary, x = ~window, y = ~quant, z = ~Var, color = ~FlagType)%>% add_markers()
plot_ly(DistSummary, x = ~window, y = ~quant, z = ~Missed, color = ~FlagType)%>% add_markers()
plot_ly(DistSummary, x = ~window, y = ~quant, z = ~n, color = ~FlagType)%>% add_markers()

DateDistDF%>%
  ggplot()+
  stat_count(aes(x = FlagError, fill = FlagType,
                     y = ..prop..),
                 position = "dodge")+
  facet_grid(window~quant)

DistSummary%>%
  arrange(MeanErrorSquard)
```



```{r}
#"case_flag_Cases"                         "case_flag_7DayCases"                    
#"case_flag_plus_comm.threshold_Cases"     "case_flag_plus_comm.threshold_7DayCases"
#"slope_switch_flag_Cases"                 "slope_switch_flag_7DayCases"
edgeThresh <- 21
DateDistDF <- date_distance_calc(date_Flag_DF, "case_flag_7DayCases", 
                                 dep_flags, edge = edgeThresh)%>%
  select(site, date, dep_flags)%>%
  tidyr::pivot_longer(cols = dep_flags,
                      names_to = c("FlagType","window", "quant"),
                      values_to = "FlagError",
                      names_sep = "_")%>%
  mutate(window = as.numeric(window), quant = as.numeric(quant))

DistSummary <- DateDistDF%>%
  group_by(window, quant, FlagType)%>%
  summarise(MeanErrorSquard = mean(FlagError^2, na.rm = TRUE),
            Var = var(FlagError, na.rm = TRUE),
            n = sum(!is.na(FlagError)),
            Missed = mean(FlagError == edgeThresh, na.rm = TRUE))

plot_ly(DistSummary, x = ~window, y = ~quant, z = ~MeanErrorSquard, color = ~FlagType)%>% add_markers()
plot_ly(DistSummary, x = ~window, y = ~quant, z = ~Var, color = ~FlagType)%>% add_markers()
plot_ly(DistSummary, x = ~window, y = ~quant, z = ~Missed, color = ~FlagType)%>% add_markers()
plot_ly(DistSummary, x = ~window, y = ~quant, z = ~n, color = ~FlagType)%>% add_markers()

DateDistDF%>%
  ggplot()+
  stat_count(aes(x = FlagError, fill = FlagType,
                     y = ..prop..),
                 position = "dodge")+
  facet_grid(window~quant)

DistSummary%>%
  arrange(MeanErrorSquard)
```

